# 智能问数功能需求文档

## 功能概述

智能问数功能是基于大模型与RAG（检索增强生成）技术，将业务人员的自然语言问题自动转换为可执行的SQL查询语句，并生成可视化图表。该功能旨在让不懂SQL的业务人员也能通过自然语言直接查询数据，降低数据查询门槛，提升数据分析效率。

## 用户故事

### 故事1：自然语言查询数据
**作为** 业务人员  
**我希望** 能够用自然语言提问，例如"查询各区域的销售量总和"  
**以便** 无需学习SQL语法就能获取所需数据  
**验收标准**：
- 用户输入自然语言问题后，系统能在3秒内生成SQL并返回结果
- 生成的SQL语句语法正确，能够成功执行
- 系统能够理解常见的业务术语（如"销售量"、"区域"等）

### 故事2：智能图表生成
**作为** 数据分析师  
**我希望** 系统能够根据问题自动选择合适的图表类型（柱状图、折线图、饼图等）  
**以便** 快速可视化数据，发现数据趋势和规律  
**验收标准**：
- 系统能够识别问题意图，自动选择最合适的图表类型
- 支持图表类型切换（柱状图、折线图、饼图、表格等）
- 图表数据准确，展示清晰美观

### 故事3：多轮对话上下文理解
**作为** 业务人员  
**我希望** 能够连续提问，例如先问"各区域销售量"，再问"哪个区域最高"  
**以便** 进行更深入的数据探索，无需重复说明上下文  
**验收标准**：
- 系统能够记住前一轮对话的上下文
- 后续问题能够正确引用前面的查询结果
- 支持最多10轮对话上下文记忆

### 故事4：历史对话管理
**作为** 业务人员  
**我希望** 能够查看、搜索、重命名和删除历史对话记录  
**以便** 复用之前的分析结果，追溯分析过程  
**验收标准**：
- 所有对话记录自动保存
- 支持按关键词搜索历史对话
- 支持重命名和删除对话记录
- 历史对话可以重新加载并继续对话

### 故事5：知识库配置管理
**作为** 系统管理员  
**我希望** 能够配置AI模型、术语库、SQL示例、自定义提示词等知识库  
**以便** 提升SQL生成的准确性和业务适配性  
**验收标准**：
- 支持配置多个AI模型（OpenAI、通义千问、本地模型等）
- 支持添加业务术语映射（如"销售额"→"sales_amount"）
- 支持添加SQL示例，供模型学习参考
- 支持自定义提示词模板，优化SQL生成效果

### 故事6：数据明细查看与导出
**作为** 业务人员  
**我希望** 能够查看图表对应的数据明细，并导出为Excel或CSV  
**以便** 进行进一步的数据分析和报告制作  
**验收标准**：
- 所有图表都支持查看数据明细表格
- 支持导出数据为Excel和CSV格式
- 支持导出图表为PNG图片
- 数据导出包含完整的列名和数据

## 验收标准

### 功能完整性
1. ✅ 自然语言提问功能正常工作，支持中文和英文
2. ✅ SQL自动生成准确率≥85%（在配置了术语库和SQL示例的情况下）
3. ✅ 图表自动生成功能正常，支持至少5种图表类型
4. ✅ 多轮对话上下文理解功能正常，支持最多10轮对话
5. ✅ 历史对话记录功能完整，支持CRUD操作
6. ✅ 知识库配置功能完整，所有配置项可正常保存和生效

### 性能要求
1. SQL生成响应时间≤3秒（不含数据库查询时间）
2. 图表渲染时间≤2秒（数据量≤10万条）
3. 支持并发用户数≥50
4. 数据库查询超时时间≤30秒

### 安全要求
1. ✅ 所有SQL查询必须经过参数化处理，防止SQL注入
2. ✅ 用户只能查询有权限的数据源
3. ✅ 敏感数据查询需要审计日志记录
4. ✅ 支持查询结果行数限制（默认≤10000行）

### 用户体验
1. ✅ 界面美观，操作流畅
2. ✅ 提供"猜你想问"推荐问题，降低提问门槛
3. ✅ 错误提示清晰，能够指导用户修正问题
4. ✅ 支持快捷键操作（Enter提交，Ctrl+Enter换行）

## 性能/安全/合规约束

### 性能约束
- SQL生成API响应时间：P95 ≤ 3秒
- 数据库查询超时：30秒
- 单次查询最大返回行数：10,000行
- 图表数据点最大数量：10,000个

### 安全约束
- 所有SQL查询必须使用参数化查询，禁止字符串拼接
- 用户只能访问已授权的数据源
- 敏感字段查询需要记录审计日志
- 支持IP白名单和黑名单限制

### 合规约束
- 数据查询需要符合数据隐私保护要求
- 支持数据脱敏功能（可选）
- 查询日志保留至少90天

## 不在范围内

以下功能不在本次开发范围内，但可作为后续迭代计划：

1. ❌ 实时数据流查询（仅支持静态数据查询）
2. ❌ 数据写入和更新操作（仅支持SELECT查询）
3. ❌ 复杂的数据挖掘和机器学习分析
4. ❌ 多数据源联合查询（JOIN跨数据源）
5. ❌ 自定义SQL函数和存储过程调用
6. ❌ 数据权限的细粒度控制（表级、字段级权限）
7. ❌ 移动端APP开发（仅支持Web端）
8. ❌ 离线模式（需要网络连接）


