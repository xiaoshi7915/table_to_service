# 数据库配置和迁移指南

## 概述

系统支持两种数据库类型作为本地数据库（用于服务自身数据存储）：
- **MySQL**：传统关系型数据库
- **PostgreSQL**：推荐使用，支持向量存储（pgvector扩展）

## 数据库类型切换

### 1. 配置数据库类型

在 `.env` 文件中设置 `LOCAL_DB_TYPE` 环境变量：

```bash
# 使用 PostgreSQL（推荐，支持向量存储）
LOCAL_DB_TYPE=postgresql

# 或使用 MySQL
LOCAL_DB_TYPE=mysql
```

### 2. PostgreSQL 配置示例

**本地PostgreSQL配置：**
```bash
# 本地数据库配置（PostgreSQL）
LOCAL_DB_TYPE=postgresql
LOCAL_DB_HOST=localhost
LOCAL_DB_PORT=5432
LOCAL_DB_USER=postgres
LOCAL_DB_PASSWORD=your_password
LOCAL_DB_NAME=local_service_db
```

**阿里云RDS PostgreSQL配置（推荐）：**
```bash
# 阿里云RDS PostgreSQL配置
LOCAL_DB_TYPE=postgresql
# 使用RDS的连接地址（域名），不是IP地址
LOCAL_DB_HOST=gp-bp1789ydq5950he7p-master.gpdb.rds.aliyuncs.com
LOCAL_DB_PORT=5432
LOCAL_DB_USER=cxs_vector
LOCAL_DB_PASSWORD=4441326cxs!!
LOCAL_DB_NAME=local_service
```

**重要提示：**
- 如果使用阿里云RDS，必须使用RDS控制台提供的**连接地址（域名）**，而不是IP地址
- 需要在RDS控制台配置**白名单**，添加当前服务器的公网IP地址
- 确保数据库名称正确（从RDS控制台查看）

### 3. MySQL 配置示例

```bash
# 本地数据库配置（MySQL）
LOCAL_DB_TYPE=mysql
LOCAL_DB_HOST=localhost
LOCAL_DB_PORT=3306
LOCAL_DB_USER=root
LOCAL_DB_PASSWORD=your_password
LOCAL_DB_NAME=local_service_db
```

## 数据迁移

### 从 MySQL 迁移到 PostgreSQL

#### 前置条件

1. **安装依赖**：
   ```bash
   pip install psycopg2-binary
   ```

2. **创建 PostgreSQL 数据库**：
   ```sql
   CREATE DATABASE your_database_name;
   ```

3. **配置环境变量**（可选）：
   ```bash
   # 源数据库（MySQL）
   OLD_MYSQL_HOST=localhost
   OLD_MYSQL_PORT=3306
   OLD_MYSQL_USER=root
   OLD_MYSQL_PASSWORD=your_mysql_password
   OLD_MYSQL_DB=local_service_db
   
   # 目标数据库（PostgreSQL）- 如果.env中LOCAL_DB_TYPE不是postgresql
   NEW_PG_HOST=8.136.95.86
   NEW_PG_PORT=5432
   NEW_PG_USER=cxs_vector
   NEW_PG_PASSWORD=4441326cxs!!
   NEW_PG_DB=your_database_name
   ```

#### 执行迁移

**方法1：使用配置文件（推荐）**

1. 在 `.env` 文件中配置 PostgreSQL 连接信息：
   ```bash
   LOCAL_DB_TYPE=postgresql
   LOCAL_DB_HOST=8.136.95.86
   LOCAL_DB_PORT=5432
   LOCAL_DB_USER=cxs_vector
   LOCAL_DB_PASSWORD=4441326cxs!!
   LOCAL_DB_NAME=your_database_name
   ```

2. 配置源 MySQL 数据库（通过环境变量）：
   ```bash
   OLD_MYSQL_HOST=localhost
   OLD_MYSQL_PORT=3306
   OLD_MYSQL_USER=root
   OLD_MYSQL_PASSWORD=your_mysql_password
   OLD_MYSQL_DB=local_service_db
   ```

3. 运行迁移脚本：
   ```bash
   cd /opt/table_to_service/backend
   python migrations/migrate_mysql_to_postgresql.py
   ```

**方法2：使用环境变量**

如果 `.env` 文件中 `LOCAL_DB_TYPE` 不是 `postgresql`，可以通过环境变量指定目标数据库：

```bash
export OLD_MYSQL_HOST=localhost
export OLD_MYSQL_PORT=3306
export OLD_MYSQL_USER=root
export OLD_MYSQL_PASSWORD=your_mysql_password
export OLD_MYSQL_DB=local_service_db

export NEW_PG_HOST=8.136.95.86
export NEW_PG_PORT=5432
export NEW_PG_USER=cxs_vector
export NEW_PG_PASSWORD=4441326cxs!!
export NEW_PG_DB=your_database_name

cd /opt/table_to_service/backend
python migrations/migrate_mysql_to_postgresql.py
```

#### 迁移过程

迁移脚本会执行以下操作：

1. **连接数据库**：测试 MySQL 和 PostgreSQL 连接
2. **创建表结构**：在 PostgreSQL 中创建所有表
3. **迁移数据**：按依赖顺序迁移所有表的数据
4. **重置序列**：重置 PostgreSQL 的自增序列

#### 迁移后的操作

1. **初始化 pgvector 扩展**（如果使用向量存储）：
   ```bash
   cd /opt/table_to_service/backend
   python scripts/init_pgvector.py
   ```

2. **更新配置**：确保 `.env` 文件中的 `LOCAL_DB_TYPE=postgresql`

3. **重启服务**：
   ```bash
   # 重启后端服务
   systemctl restart your_service_name
   # 或
   uvicorn app.main:app --reload
   ```

### 从 PostgreSQL 迁移到 MySQL

如果需要从 PostgreSQL 迁移回 MySQL，可以修改迁移脚本或创建反向迁移脚本。

## 向量存储配置

### PostgreSQL + pgvector

如果使用 PostgreSQL 作为本地数据库，可以启用向量存储功能：

1. **初始化 pgvector 扩展**：
   ```bash
   cd /opt/table_to_service/backend
   python scripts/init_pgvector.py
   ```

2. **验证扩展**：
   ```sql
   -- 连接到 PostgreSQL 数据库
   \dx vector
   ```

3. **检查向量表**：
   ```sql
   SELECT table_name FROM information_schema.tables 
   WHERE table_name LIKE '%_embeddings';
   ```

### MySQL（不支持向量存储）

如果使用 MySQL，向量存储功能将不可用，系统会使用简化检索模式。

## 数据库连接池配置

可以通过环境变量调整连接池参数：

```bash
# 本地数据库连接池配置
LOCAL_DB_POOL_SIZE=5          # 连接池大小（默认5）
LOCAL_DB_MAX_OVERFLOW=10     # 最大溢出连接数（默认10）
DB_POOL_RECYCLE=3600         # 连接回收时间（秒，默认1小时）
```

## 常见问题

### 1. 连接失败

**问题**：无法连接到数据库

**解决方案**：
- 检查数据库服务是否运行
- 验证连接信息（host、port、user、password）
- 检查防火墙设置
- 对于 PostgreSQL，确保 `psycopg2-binary` 已安装

### 2. 迁移失败

**问题**：数据迁移过程中出错

**解决方案**：
- 检查源数据库和目标数据库的连接
- 确保目标数据库已创建
- 查看迁移日志了解具体错误
- 如果部分表迁移失败，可以手动修复后继续

### 3. 向量存储不可用

**问题**：使用 MySQL 时向量存储功能不可用

**解决方案**：
- 切换到 PostgreSQL 数据库
- 或接受使用简化检索模式（功能正常但检索精度可能略低）

### 4. 字符编码问题

**问题**：迁移后出现乱码

**解决方案**：
- MySQL 使用 `utf8mb4` 编码
- PostgreSQL 默认使用 `UTF8` 编码
- 确保数据库和表的字符集设置正确

## 最佳实践

1. **生产环境推荐使用 PostgreSQL**：
   - 支持向量存储（pgvector）
   - 更好的 JSON 支持
   - 更强大的查询功能

2. **迁移前备份数据**：
   ```bash
   # MySQL 备份
   mysqldump -u root -p local_service_db > backup.sql
   
   # PostgreSQL 备份
   pg_dump -h 8.136.95.86 -U cxs_vector your_database_name > backup.sql
   ```

3. **测试迁移**：
   - 先在测试环境验证迁移脚本
   - 确认数据完整性
   - 测试应用功能

4. **监控连接池**：
   - 根据实际负载调整连接池大小
   - 监控连接数使用情况

## 相关文件

- 配置文件：`backend/app/core/config.py`
- 数据库连接：`backend/app/core/database.py`
- 迁移脚本：`backend/migrations/migrate_mysql_to_postgresql.py`
- pgvector 初始化：`backend/scripts/init_pgvector.py`
- 环境变量示例：`env.example`

